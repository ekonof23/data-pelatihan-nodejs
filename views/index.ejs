<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <title>Data Pelatihan</title>
</head>

<body>
  <!-- popup-box -->
  <div class="modal-box">
    <!-- hapus pelatihan -->
    <div class="hapus-item">
      <button class="close-update"><span class="material-symbols-outlined">
          close </span></button>
      <span id="icon-delete" class="material-symbols-outlined"> delete </span>
      <h3 class="confirm">Yakin Hapus Data ?</h3>

      <div class="btn-horizontal">
        <button class="btn-ya">Ya</button>
        <button class="btn-batal">Batal</button>
      </div>
    </div>


    <!-- tampil pelatihan -->
    <div class="detail-pelatihan">
      <button class="close-update"><span class="material-symbols-outlined">
          close </span></button>
      <ul id="populateTampilForm">
        <li type="text" class="judul_pelatihan" name="judul_pelatihan" value=""></li>
        <li type="date" class="tanggal_pelatihan" name="tanggal_pelatihan" value=""></li>
        <li type="text" class="tempat_pelatihan" name="tempat_pelatihan" value=""></li>
        <li type="text" class="trainers" name="trainers" value=""></li>
        <li class="list_peserta"></li>
      </ul>
    </div>

    <!-- update pelatihan -->
    <div class="update-pelatihan">
      <button class="close-update"><span class="material-symbols-outlined">
          close </span></button>
      <form id="populateUpdateForm">
        <div class="row_update1">
          <input type="text" name="id" required /><br />
          <label class="label-add">Judul Pelatihan:</label><br />
          <input type="text" name="judul_pelatihan" required /><br />
          <label class="label-add">Tanggal Pelatihan:</label><br />
          <input class="tgl" name="tanggal_pelatihan" type="date" required /><br />
          <label class="label-add">Tempat Pelatihan:</label><br />
          <input type="text" name="tempat_pelatihan" required /><br />
          <label class="label-add">Trainers:</label><br />
          <input type="text" name="trainers" required /><br />
        </div>
        <div class="row_update2">
          <button class="submit-data_update" onclick="updatePelatihan()" type="submit" value="Update">Update</button>
        </div>
      </form>
    </div>

    <!-- update perusahaan -->
    <div class="update-perusahaan">
      <button class="close-update"><span class="material-symbols-outlined">
          close </span></button>
      <form id="PopulateupdatePerusahaan">
        <div class="row_update3">
          <table>
            <thead>

            </thead>
            <tbody class="list-perusahaan">
            </tbody>
          </table>
          <!-- hapus perusahaan -->
          <div class="hapus-perusahaan">
            <button class="close-update"><span class="material-symbols-outlined">
                close </span></button>
            <span id="icon-delete" class="material-symbols-outlined"> delete </span>
            <h3 class="confirm">Yakin Hapus Data ?</h3>
            <div class="btn-horizontal">
              <button class="btn-ya">Ya</button>
              <button class="btn-batal">Batal</button>
            </div>
          </div>
        </div>
      </form>
      <br>
      <div class="button-container">
        <button class="tambah-perusahaan" onclick="openCreatePopup()">
          <span class="front">Tambah Perusahaan</span>
        </button>
        <button class="tambah-peserta" onclick="openCreatePopup()">
          <span class="front">Tambah Peserta</span>
        </button>
      </div>
    </div>

    <!-- update peserta -->
    <div class="update-peserta">
      <button class="close-update"><span class="material-symbols-outlined">
          close </span></button>
      <form id="PopulateupdatePeserta">
        <div class="row_update4">
          <table>
            <thead>

            </thead>

            <tbody class="list-peserta">
            </tbody>
          </table>
        </div>
      </form>
      <br>
      <button class="tambah-peserta" onclick="openCreatePopup()">
        <span class="front">Tambah</span>
      </button>
    </div>
  </div>

  <div class="card">
    <h1>Data Pelatihan</h1>
  </div>
  <div class="card">

    <!-- add data pelatihan -->
    <div id="addPelatihanForm">
      <button class="close-pelatihan">
        <span class="material-symbols-outlined"> close </span>
      </button>
      <br />
      <form class="form-post" method="post" action="/add">
        <div class="row_add1">
          <label class="label-add">Judul Pelatihan:</label><br />
          <input type="text" name="judul_pelatihan" required /><br />
          <label class="label-add">Tanggal Pelatihan:</label><br />
          <input type="date" name="tanggal_pelatihan" required /><br />
          <label class="label-add">Tempat Pelatihan:</label><br />
          <input type="text" name="tempat_pelatihan" required /><br />
          <label class="label-add">Trainers:</label><br />
          <input type="text" name="trainers" required /><br />
        </div>
        <div class="row_add2">
          <button class="input-submit" type="submit" value="Tambah">Tambah</button>
        </div>
      </form>
      <br />
    </div>

    <!-- add data perusahaan -->
    <div id="addPelatihanPerusahaan">
      <button class="close-perusahaan">
        <span class="material-symbols-outlined"> close </span>
      </button>
      <br />
      <form class="form-post" method="post" action="/add2">
        <div class="row_add1">
          <label class="label-add">Nama:</label><br />
          <input type="text" name="nama" required /><br />
          <label class="label-add">Alamat:</label><br />
          <input type="text" name="alamat" required /><br />
          <label class="label-add">No Telpon:</label><br />
          <input type="text" name="no_telpon" required /><br />

        </div>
        <div class="row_add2">
          <button class="input-submit" type="submit" value="Tambah">Tambah</button>
        </div>
      </form>
      <br />
    </div>

    <!-- add data peserta -->
    <div id="addPelatihanPeserta">
      <button class="close-peserta">
        <span class="material-symbols-outlined"> close </span>
      </button>
      <br />
      <form class="form-post" method="post" action="/add3">
        <div class="row_add1">
          <label class="label-add">Nama:</label><br />
          <input type="text" name="judul_pelatihan" required /><br />
          <label class="label-add">Tanggal Lahir:</label><br />
          <input type="date" name="tanggal_lahir" required /><br />
          <label class="label-add">Gender:</label><br />
          <input type="text" name="gender" required /><br />
        </div>
        <div class="row_add2">
          <button class="input-submit" type="submit" value="Tambah">Tambah</button>
        </div>
      </form>
      <br />
    </div>

    <div class="input-container">
      <button class="tambah-data" onclick="openCreatePopup()">
        <span class="front">Tambah</span>
      </button>
      <input type="text" id="search" placeholder="Search..." class="form-control" autocomplete="off" />
    </div>
    <table id="training-table">
      <thead>
        <tr>
          <th class="no">No</th>
          <th>Judul Pelatihan</th>
          <th>Tanggal Pelatihan</th>
          <th>Tempat Pelatihan</th>
          <th>Trainers</th>
          <th>Hapus</th>
          <th>Tampil</th>
          <th>Pelatihan</th>
          <th>Perusahaan & Peserta</th>
        </tr>

      <tbody id="results"></tbody>
      </thead>
    </table>
  </div>

  <script>


    // add data pelatihan
    document.querySelector(".tambah-data").onclick = () => {
      document.querySelector("#addPelatihanForm").classList.add("show");
    };
    document.querySelector(".close-pelatihan").onclick = () => {
      document.querySelector("#addPelatihanForm").classList.remove("show");
    };
    function addPelatihan() {
      fetch("/add")
        .then((response) => response.json())
        .then((data) => {
          if (data.length !== 0) {
            const popupContent = `
            <div>
              <h2>Data Pelatihan</h2>
              <ul>
                ${data
                .map((pelatihan) => `<li>${pelatihan.judul_pelatihan}</li>`)
                .join("")}
              </ul>
              <!-- Add more data fields as needed -->
            </div>
          `;
            alert(popupContent);
          } else {
            alert("No Data Found");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }

    // add data perusahaan
    document.querySelector(".tambah-perusahaan").onclick = () => {
      document.querySelector("#addPelatihanPerusahaan").classList.add("show");
    };
    document.querySelector(".close-perusahaan").onclick = () => {
      document.querySelector("#addPelatihanPerusahaan").classList.remove("show");
    };
    function addPerusahaan() {
      fetch("/add2")
        .then((response) => response.json())
        .then((data) => {
          if (data.length !== 0) {
            const popupContent = `
            <div>
              <h2>Data Pelatihan</h2>
              <ul>
                ${data
                .map((perusahaan) => `<li>${perusahaan.nama}</li>`)
                .join("")}
              </ul>
              <!-- Add more data fields as needed -->
            </div>
          `;
            alert(popupContent);
          } else {
            alert("No Data Found");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }


    // add data peserta
    document.querySelector(".tambah-peserta").onclick = () => {
      document.querySelector("#addPelatihanPeserta").classList.add("show");
    };
    document.querySelector(".close-peserta").onclick = () => {
      document.querySelector("#addPelatihanPeserta").classList.remove("show");
    };
    function addPeserta() {
      fetch("/add3")
        .then((response) => response.json())
        .then((data) => {
          if (data.length !== 0) {
            const popupContent = `
            <div>
              <h2>Data Pelatihan</h2>
              <ul>
                ${data
                .map((peserta) => `<li>${peserta.nama}</li>`)
                .join("")}
              </ul>
              <!-- Add more data fields as needed -->
            </div>
          `;
            alert(popupContent);
          } else {
            alert("No Data Found");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }

    // delete data pelatihan
    const popup = document.querySelector(".modal-box");
    const tbody = document.querySelector("tbody#results");
    let idItem = 0;
    tbody.onclick = (e) => {
      let I = e.target,
        cls = I.classList;

      if (cls.contains("popup")) {
        let boxItem =
          cls.contains("hapusItem") ? ".hapus-item" :
            cls.contains("hapusPerusahaan") ? ".hapus-perusahaan" :
              cls.contains("updateItem") ? ".update-pelatihan" :
                cls.contains("updatePerusahaanItem") ? ".update-perusahaan" :
                  cls.contains("tampilItem") ? ".detail-pelatihan" :
                    false;
        if (boxItem) {

          popup.classList.add("active");
          popup.querySelector(boxItem).classList.add("active");
          idItem = I.dataset.id;

          if (boxItem == ".update-pelatihan") {
            getPelatihanUpdate(idItem);
          } else {
            (boxItem == "")
          }
          if (boxItem == ".update-peserta") {
            getPesertaUpdate(idItem);
          } else {
            (boxItem == "")
          }
          if (boxItem == ".update-perusahaan") {
            getPerusahaanUpdate(idItem);
          } else {
            (boxItem == "")
          }
          if (boxItem == ".detail-pelatihan") {
            getPelatihanTampil(idItem);
          } else {
            (boxItem == "")
          }
        }
      }
    };

    // Fungsi untuk menampilkan popup


    // Fungsi untuk menyembunyikan popup
    function sembunyikanPopup() {
      var popup = document.querySelector('.hapus-perusahaan');
      popup.classList.remove('active');
    }

    document.querySelector("#PopulateupdatePerusahaan .list-perusahaan").onclick = (e) => {
      let button = e.target.closest("button");

      if (button) {
        let td = button.closest("td");
        let idItem = td.closest("tr").dataset.id;
        let table = td.closest("tr").dataset.table;

        if (table === "perusahaan") {
          let konfirmasi = window.confirm("Apakah Anda yakin ingin menghapus?");
          if (konfirmasi) {
            window.location = "/delete2/" + idItem;
          }
        } else if (table === "peserta") {
          let konfirmasi = window.confirm("Apakah Anda yakin ingin menghapus?");
          if (konfirmasi) {
            window.location = "/delete3/" + idItem;
          }
        }
      };
    }

    popup.onclick = (e) => {
      let targetElement = e.target;
      if (targetElement.classList.contains("btn-ya")) {
        popup.classList.remove("active");
        popup.querySelector(".active").classList.remove("active");
        window.location = "/delete/" + idItem;
      } else if (targetElement.classList.contains("btn-batal")) {
        popup.classList.remove("active");
        popup.querySelector(".active").classList.remove("active");
      } else {
        let closeTampilButton = targetElement.closest(".close-tampil");
        let closeUpdateButton = targetElement.closest(".close-update");

        if (closeTampilButton || closeUpdateButton) {
          popup.classList.remove("active");
          popup.querySelector(".active").classList.remove("active");
        }
      }
    };

    // update data pelatihan
    function getPelatihanUpdate(pelatihanId) {
      fetch(`/edit/${pelatihanId}`)
        .then((response) => response.json())
        .then((response) => {
          populateUpdateForm(response);
          console.log(response);
        })

        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }


    function updatePelatihan() {
      const form = document.getElementById("populateUpdateForm");
      const formData = new FormData(form);

      fetch(`/update`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(Object.fromEntries(formData)),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.length !== 0) {
            const popupContent = `
          <div>
            <h2>Data Pelatihan</h2>
            <ul>
              ${data
                .map((pelatihan) => `<li>${pelatihan.judul_pelatihan} - ${pelatihan.tanggal_pelatihan}</li>`)
                .join("")}
            </ul>

          </div>
        `;
            alert(popupContent);
          } else {
            alert("No Data Found");
          }
        })
        .catch((error) => {
          console.error("Error updating data:", error);
        });
    }

    function populateUpdateForm(data) {
      document.querySelector("#populateUpdateForm [name='id']").value = data.id;
      document.querySelector("#populateUpdateForm [name='judul_pelatihan']").value = data.judul_pelatihan;
      document.querySelector("#populateUpdateForm [name='tanggal_pelatihan']").value = new Date(data.tanggal_pelatihan).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
      document.querySelector("#populateUpdateForm [name='tempat_pelatihan']").value = data.tempat_pelatihan;
      document.querySelector("#populateUpdateForm [name='trainers']").value = data.trainers;
    }


    function getPerusahaanUpdate(pelatihanId) {
      fetch(`/pelatihan/${pelatihanId}/json`)
        .then((response) => response.json())
        .then((response) => {
          PopulateupdatePerusahaan(response);
          console.log(response);
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }

    function getPesertaUpdate(pelatihanId) {
      fetch(`/pelatihan/${pelatihanId}/json`)
        .then((response) => response.json())
        .then((response) => {
          PopulateupdatePeserta(response);
          console.log(response);
        })

        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }


    function PopulateupdatePerusahaan(pelatihan) {
      let pesertaHTML = "";
      pelatihan.list_peserta.forEach((perusahaan, i) => {
        pesertaHTML += `<tr data-id="${perusahaan.id}" data-table="perusahaan"><td>Perusahaan :</td><td  data-col="nama">${perusahaan.nama}</td>
          <td  data-col="alamat">${perusahaan.alamat}</td><td  data-col="no_telpon">${perusahaan.no_telpon}</td><td><button class="btn-hapus-perusahaan"onclick="hapusPerusahaan(${perusahaan.id})">
            Hapus</button></td>  
          </tr>`;

        perusahaan.peserta.forEach((peserta, j) => {
          pesertaHTML += `<tr data-id="${peserta.id}" data-table="peserta"><td>Peserta :</td><td  data-col="nama">${peserta.nama}</td>
            <td  data-col="tanggal_lahir">${new Date(peserta.tanggal_lahir).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</td><td  data-col="gender">${peserta.gender}</td><td><button class="btn-hapus-peserta">Hapus</button></td></tr><br><br>`;
        })
      })

      document.querySelector("#PopulateupdatePerusahaan .list-perusahaan").innerHTML = pesertaHTML;
    }


    document.querySelector("#PopulateupdatePerusahaan .list-perusahaan").ondblclick = (e) => {
      let td = e.target.closest("td");
      if (td) {
        td.setAttribute("contenteditable", true);
        td.focus();
        td.onblur = (e) => {
          let I = e.target;
          I.setAttribute("contenteditable", false);
          let table = td.closest("tr").dataset.table;

          if (table === "perusahaan") {
            updatePerusahaan({
              id: td.closest("tr").dataset.id,
              table: table,
              col: td.dataset.col,
              val: td.innerText.trim()
            })
          } else if (table === "peserta") {
            updatePeserta({
              id: td.closest("tr").dataset.id,
              table: table,
              col: td.dataset.col,
              val: td.innerText.trim()
            })
          }

        }
      }
    }

    function updatePerusahaan(perusahaan) {
      fetch(`/update2`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(perusahaan)
      })
        .then((response) => response.json())
        .then(perusahaan => {
          console.log("Data perusahaan berhasil diupdate");
        })
        .catch(error => {
          console.error("Gagal mengupdate data perusahaan:", error);
        });
    }

    function updatePeserta(peserta) {
      fetch(`/update3`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(peserta)
      })
        .then((response) => response.json())
        .then(peserta => {
          console.log("data berhasil diupdate");
        })

    }


    document.querySelector(".tambah-perusahaan").onclick = () => {
      document.querySelector("#addPelatihanPerusahaan").classList.add("show");
    };

    function getHapusPerusahaan(pelatihanId) {
      fetch(`/delete2/${pelatihanId}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then((pelatihan) => {
          if (pelatihan) {
            populateTampilForm(pelatihan);
            console.log(pelatihan);
          } else {
            alert("Pelatihan not found");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }

    // view data pelatihan
    function getPelatihanTampil(pelatihanId) {
      fetch(`/pelatihan/${pelatihanId}/json`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then((pelatihan) => {
          if (pelatihan) {
            populateTampilForm(pelatihan);
            console.log(pelatihan);
          } else {
            alert("Pelatihan not found");
          }
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });
    }

    // Fungsi untuk menampilkan data pelatihan
    function populateTampilForm(pelatihan) {
      let show = document.getElementById("populateTampilForm");
      show.querySelector(".judul_pelatihan").innerHTML = `Judul Pelatihan : ${pelatihan.judul_pelatihan}`;
      show.querySelector(".tanggal_pelatihan").innerHTML = `Tanggal Pelatihan : ${new Date(pelatihan.tanggal_pelatihan).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`;
      show.querySelector(".tempat_pelatihan").innerHTML = `Tempat Pelatihan : ${pelatihan.tempat_pelatihan}`;
      show.querySelector(".trainers").innerHTML = `Trainers : ${pelatihan.trainers}`;
      show.querySelector(".list_peserta").innerHTML = pelatihan.id_perusahaan;


      let pesertaHTML = "<li>List Peserta :</li><ul>";
      for (const perusahaan of pelatihan.list_peserta) {
        pesertaHTML += `<h4>${perusahaan.nama}</h4>
        <ol>Alamat : ${perusahaan.alamat}</ol>
        <ol>No. Telpon : ${perusahaan.no_telpon}</ol>`;
        for (const peserta of perusahaan.peserta) {
          pesertaHTML += `<li>Nama: ${peserta.nama}, Tanggal Lahir: ${new Date(peserta.tanggal_lahir).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}, Gender: ${peserta.gender}</li>`;
        }
      }
      pesertaHTML += "</ul>";
      show.querySelector(".list_peserta").innerHTML = pesertaHTML;
    }


    // live search Ajax
    const searchInput = document.querySelector("#search");
    const results_body = document.querySelector("#results");

    load_data();

    function load_data(query = "") {
      const request = new XMLHttpRequest();

      request.open("GET", `/search?q=${query}`);

      request.onload = () => {
        const results = JSON.parse(request.responseText);

        let html = "";

        if (results.length > 0) {
          let no = 1;
          results.forEach((result) => {
            html +=
              `<tr>
                  <td>${no++}</td>
                  <td>${result.judul_pelatihan}</td>
                  <td>${new Date(result.tanggal_pelatihan).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</td>
                  <td>${result.tempat_pelatihan}</td>
                 
                  <td>${result.trainers}</td>
                  <td>
                    <a class="hapusItem popup" data-id="${result.id}">Hapus</a>
                  </td>
                  <td>
                    <a class="tampilItem popup" data-id="${result.id}">Tampil</a>
                  </td>
                  <td>
                    <a class="updateItem popup" data-id="${result.id}">Edit</a>
                  </td>
                  <td>
                    <a class="updatePerusahaanItem popup" data-id="${result.id}">Edit + Tambah + Hapus</a>
                  </td>                 
                </tr>
                `;
          });
        } else {
          html += `
            <tr>
                <td colspan="9" class="text-center">No Data Found</td>
            </tr>
            `;
        }

        results_body.innerHTML = html;
      };

      request.send();
    }

    searchInput.addEventListener("input", () => {
      const query = searchInput.value;

      load_data(query);
    });

    document.addEventListener("DOMContentLoaded", function () {
      var tableRows = document.querySelectorAll("#training-table tbody tr");

      for (var i = 0; i < tableRows.length; i++) {
        if (i % 2 === 0) {
          tableRows[i].classList.add("even-row");
        } else {
          tableRows[i].classList.add("odd-row");
        }
      }
    });

  </script>
</body>

</html>